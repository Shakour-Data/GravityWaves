{% extends "base.html" %}

{% block title %}{% if ticker %}{{ ticker }} Status Analysis{% else %}Market Status Analysis{% endif %}{% endblock %}

{% block content %}

<h1 id="page-title">{% if ticker %}{{ ticker }} Status Analysis{% else %}Market Status Analysis{% endif %}</h1>

<!-- Removed the main content form for user settings to enforce sidebar-only input -->
<!-- The form below was removed to comply with user requirement that settings input is only via sidebar -->



<section id="current-status" class="section-container">
    <h2>Current Market Status</h2>
    <p>Market State: <span id="current-market-state">Loading...</span></p>
    <p>Volatility Regime: <span id="current-volatility-regime">Loading...</span></p>
</section>

<section id="historical-distribution" class="section-container">
    <h2>Historical Distribution</h2>
    <div style="display: flex; gap: 20px; justify-content: space-between; align-items: flex-start;">
        <div class="chart-box market-state-distribution-box" style="flex: 1; min-width: 300px;">
            <canvas id="market-state-distribution-chart" style="max-height: 300px;"></canvas>
            <table id="market-state-distribution-table" class="distribution-table">
                <thead>
                    <tr>
                        <th>Market State</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="volatility-regime-distribution-box chart-box" style="flex: 1; min-width: 300px;">
            <canvas id="volatility-regime-distribution-chart" style="max-height: 300px;"></canvas>
            <table id="volatility-regime-distribution-table" class="distribution-table">
                <thead>
                    <tr>
                        <th>Volatility Regime</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</section>

<section id="time-series-charts" class="section-container">
    <h2>Market State and Volatility Over Time</h2>
    <div class="market-state-time-series-container">
        <div class="chart-box time-series-chart">
            <canvas id="market-state-time-series-chart"></canvas>
        </div>
    </div>
    <div class="volatility-regime-time-series-container">
        <div class="chart-box time-series-chart">
            <canvas id="volatility-regime-time-series-chart"></canvas>
        </div>
    </div>
</section>

<section id="forecast-chart" class="section-container">
    <h2>Market State Forecast</h2>
    <div class="forecast-chart-container">
        <div class="chart-box forecast-chart">
            <canvas id="market-state-forecast-chart"></canvas>
        </div>
        <div class="chart-box forecast-chart">
            <canvas id="volatility-forecast-chart"></canvas>
        </div>
    </div>
</section>

<section id="comparison-section" class="section-container">
    <h2>Actual vs Forecast Comparison (Last 30 Days)</h2>
    <div class="comparison-chart-container">
        <div class="chart-box comparison-chart-box">
            <canvas id="comparison-chart"></canvas>
        </div>
    </div>
    <div id="comparison-stats" class="comparison-stats">
        <!-- Summary statistics will be shown here -->
    </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const marketStateDistCtx = document.getElementById('market-state-distribution-chart').getContext('2d');
    const volatilityRegimeDistCtx = document.getElementById('volatility-regime-distribution-chart').getContext('2d');
    const marketStateTimeCtx = document.getElementById('market-state-time-series-chart').getContext('2d');
    const volatilityRegimeTimeCtx = document.getElementById('volatility-regime-time-series-chart').getContext('2d');
    const forecastCtx = document.getElementById('market-state-forecast-chart').getContext('2d');
    const comparisonCtx = document.getElementById('comparison-chart').getContext('2d');

    const stateMap = {
        'EXTREME_BULLISH': 5,
        'BULLISH': 4,
        'NEUTRAL': 3,
        'BEARISH': 2,
        'EXTREME_BEARISH': 1
    };

    let marketStateDistChart = new Chart(marketStateDistCtx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#b71c1c', '#fb8c00', '#9e9e9e', '#aed581', '#1b5e20']  // Market state colors: red, orange, gray, light green, dark green
            }]
        }
    });

    let volatilityRegimeDistChart = new Chart(volatilityRegimeDistCtx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#f44336', '#ff9800', '#9e9e9e', '#8bc34a', '#388e3c']  // Volatility regime colors: bright red, bright orange, gray, light green, dark green
            }]
        }
    });

    function updateDistributionTable(tableId, data) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '';
        for (const [key, value] of Object.entries(data)) {
            const row = document.createElement('tr');
            const keyCell = document.createElement('td');
            keyCell.textContent = key;
            const valueCell = document.createElement('td');
            valueCell.textContent = value;
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            tbody.appendChild(row);
        }
    }

    let marketStateTimeSeriesChart = new Chart(marketStateTimeCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Market State',
                data: [],
                borderColor: '#4caf50',
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            const labels = ['','EXTREME_BEARISH','BEARISH','NEUTRAL','BULLISH','EXTREME_BULLISH'];
                            return labels[value] || value;
                        },
                        stepSize: 1,
                        min: 1,
                        max: 5
                    }
                }
            }
        }
    });

    let volatilityRegimeTimeSeriesChart = new Chart(volatilityRegimeTimeCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Volatility Regime',
                data: [],
                borderColor: '#f57c00',
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            const labels = ['','Extreme_Low','low','Neutral','high','Extreme_high'];
                            return labels[value] || value;
                        },
                        stepSize: 1,
                        min: 1,
                        max: 5
                    }
                }
            }
        }
    });

    let forecastChart = new Chart(forecastCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Forecasted Market State',
                data: [],
                borderColor: '#2196f3',
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            const labels = ['','EXTREME_BEARISH','BEARISH','NEUTRAL','BULLISH','EXTREME_BULLISH'];
                            return labels[value] || value;
                        },
                        stepSize: 1,
                        min: 1,
                        max: 5
                    }
                }
            }
        }
    });

    const volatilityForecastCtx = document.getElementById('volatility-forecast-chart').getContext('2d');
    let volatilityForecastChart = new Chart(volatilityForecastCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Forecasted Volatility Regime',
                data: [],
                borderColor: '#f57c00',
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            const labels = ['','Extreme_Low','low','Neutral','high','Extreme_high'];
                            return labels[value] || value;
                        },
                        stepSize: 1,
                        min: 1,
                        max: 5
                    }
                }
            }
        }
    });

    let comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Actual Market State',
                    data: [],
                    backgroundColor: 'rgba(76, 175, 80, 0.5)'
                },
                {
                    label: 'Forecasted Market State',
                    data: [],
                    backgroundColor: 'rgba(33, 150, 243, 0.5)'
                }
            ]
        },
        options: {
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            const labels = ['','EXTREME_BEARISH','BEARISH','NEUTRAL','BULLISH','EXTREME_BULLISH'];
                            return labels[value] || value;
                        },
                        stepSize: 1,
                        min: 1,
                        max: 5
                    }
                }
            }
        }
    });

    function fetchMarketStatusData() {
        const ticker = "{{ ticker or 'AAPL' }}";
        const analysis_date = new Date().toISOString().split('T')[0];
        const timeframe = '1d';
        const candle_count = 500;
        const investment_horizon = 10;
        const data_source = 'yahoo';

        fetch('/api/market_status_analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ticker: ticker,
                analysis_date: analysis_date,
                timeframe: timeframe,
                candle_count: candle_count,
                investment_horizon: investment_horizon,
                data_source: data_source
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('current-market-state').textContent = data.current_market_state || 'N/A';
            document.getElementById('current-volatility-regime').textContent = data.volatility_regime || 'N/A';

            if (data.historical_distribution) {
                marketStateDistChart.data.labels = Object.keys(data.historical_distribution.market_state || {});
                marketStateDistChart.data.datasets[0].data = Object.values(data.historical_distribution.market_state || {});
                marketStateDistChart.update();
                updateDistributionTable('market-state-distribution-table', data.historical_distribution.market_state || {});

                volatilityRegimeDistChart.data.labels = ['Extreme_Low','low','Neutral','high','Extreme_high'];
                volatilityRegimeDistChart.data.datasets[0].data = Object.values(data.historical_distribution.volatility_regime || {});
                volatilityRegimeDistChart.update();
                updateDistributionTable('volatility-regime-distribution-table', data.historical_distribution.volatility_regime || {});
            } else {
                marketStateDistChart.data.labels = [];
                marketStateDistChart.data.datasets[0].data = [];
                marketStateDistChart.update();
                updateDistributionTable('market-state-distribution-table', {});

                volatilityRegimeDistChart.data.labels = [];
                volatilityRegimeDistChart.data.datasets[0].data = [];
                volatilityRegimeDistChart.update();
                updateDistributionTable('volatility-regime-distribution-table', {});
            }

            if (data.time_series) {
                marketStateTimeSeriesChart.data.labels = data.time_series.dates || [];
                marketStateTimeSeriesChart.data.datasets[0].data = (data.time_series.market_state || []).map(s => stateMap[s] || 0);
                marketStateTimeSeriesChart.update();

                volatilityRegimeTimeSeriesChart.data.labels = data.time_series.dates || [];
                volatilityRegimeTimeSeriesChart.data.datasets[0].data = (data.time_series.volatility_regime || []).map(s => stateMap[s] || 0);
                volatilityRegimeTimeSeriesChart.update();
            } else {
                marketStateTimeSeriesChart.data.labels = [];
                marketStateTimeSeriesChart.data.datasets[0].data = [];
                marketStateTimeSeriesChart.update();

                volatilityRegimeTimeSeriesChart.data.labels = [];
                volatilityRegimeTimeSeriesChart.data.datasets[0].data = [];
                volatilityRegimeTimeSeriesChart.update();
            }

            if (data.forecast) {
                forecastChart.data.labels = data.forecast.dates || [];
                forecastChart.data.datasets[0].data = (data.forecast.market_state || []).map(s => stateMap[s] || 0);
                forecastChart.update();

                volatilityForecastChart.data.labels = data.forecast.dates || [];
                volatilityForecastChart.data.datasets[0].data = (data.forecast.volatility_regime || []).map(s => stateMap[s] || 0);
                volatilityForecastChart.update();
            } else {
                forecastChart.data.labels = [];
                forecastChart.data.datasets[0].data = [];
                forecastChart.update();

                volatilityForecastChart.data.labels = [];
                volatilityForecastChart.data.datasets[0].data = [];
                volatilityForecastChart.update();
            }

            if (data.comparison) {
                comparisonChart.data.labels = data.comparison.dates || [];
                comparisonChart.data.datasets[0].data = (data.comparison.actual || []).map(s => stateMap[s] || 0);
                comparisonChart.data.datasets[1].data = (data.comparison.forecast || []).map(s => stateMap[s] || 0);
                comparisonChart.update();

                let correctCount = 0;
                const actual = data.comparison.actual || [];
                const forecasted = data.comparison.forecast || [];
                for (let i = 0; i < actual.length; i++) {
                    if (actual[i] === forecasted[i]) {
                        correctCount++;
                    }
                }
                const accuracy = actual.length > 0 ? (correctCount / actual.length) * 100 : 0;
                document.getElementById('comparison-stats').textContent = `Forecast Accuracy over last ${actual.length} days: ${accuracy.toFixed(2)}%`;
            } else {
                comparisonChart.data.labels = [];
                comparisonChart.data.datasets[0].data = [];
                comparisonChart.data.datasets[1].data = [];
                comparisonChart.update();
                document.getElementById('comparison-stats').textContent = '';
            }
        })
        .catch(error => {
            console.error('Error fetching market status data:', error);
            document.getElementById('current-market-state').textContent = 'Error';
            document.getElementById('current-volatility-regime').textContent = 'Error';
        });
    }

    fetchMarketStatusData();
});
</script>
{% endblock %}
